// Generated by CoffeeScript 1.6.2
require(["moment"], function() {
  var $header, $issue, $issues, $popup, UserTimeReport, data, day, header, key, lastDay, padNumber, project, sum, sumByDay, sumByIssue, sumOverall, _i, _j, _ref, _ref1;

  UserTimeReport = (function() {
    function UserTimeReport() {}

    return UserTimeReport;

  })();
  data = {
    "user": "tmbo",
    "projects": {
      "brainflight": [
        {
          "issueNumber": 0,
          "time": 10,
          "title": "BF-101 Build time tracker",
          "date": "2013-08-01T00:08:59.181Z"
        }, {
          "issueNumber": 2,
          "time": 60,
          "title": "BF-12 Work some more!",
          "date": "2013-08-12T00:08:59.181Z"
        }
      ],
      "oxalis": [
        {
          "issueNumber": 4,
          "time": 10,
          "title": "OX-1 satisfy Moritz",
          "date": "2013-08-30T00:08:59.181Z"
        }, {
          "issueNumber": 12,
          "time": 60,
          "title": "OX-1000 sell Oxalis",
          "date": "2013-08-10T00:08:59.181Z"
        }
      ]
    }
  };
  $("#main-container").removeClass("container");
  padNumber = function(number) {
    return String("0" + number).slice(-2);
  };
  $("#user").text("" + data.user);
  $("#timespan").text("| " + (moment().startOf("month").format("D MMM YYYY")) + " - " + (moment().endOf("month").format("D MMM YYYY")));
  header = [];
  header.push("Key");
  header.push("Summary");
  header.push("Sum");
  lastDay = moment().endOf("month").date();
  for (day = _i = 1; 1 <= lastDay ? _i <= lastDay : _i >= lastDay; day = 1 <= lastDay ? ++_i : --_i) {
    header.push(padNumber(day));
  }
  $header = $("<tr>");
  header.forEach(function(h) {
    return $header.append("<th>" + h + "</th>");
  });
  $("#timetable thead").append($header);
  sumByIssue = {};
  sumByDay = {};
  sumOverall = 0;
  _ref = data.projects;
  for (key in _ref) {
    project = _ref[key];
    project.forEach(function(issue) {
      sumByIssue[issue.issueNumber] = sumByIssue[issue.issueNumber] + issue.time || issue.time;
      day = moment(issue.date).date();
      sumByDay[day] = sumByDay[day] + issue.time || issue.time;
      return sumOverall += issue.time;
    });
  }
  $issues = $("<tbody>");
  _ref1 = data.projects;
  for (key in _ref1) {
    project = _ref1[key];
    project.forEach(function(issue) {
      var $issue, _j;

      $issue = $("<tr>");
      $issue.append("<td>" + issue.issueNumber + "</td>");
      $issue.append("<td>" + issue.title + "</td>");
      $issue.append($("<td>", {
        "class": "sumByIssue",
        text: "" + sumByIssue[issue.issueNumber]
      }));
      for (day = _j = 1; 1 <= lastDay ? _j <= lastDay : _j >= lastDay; day = 1 <= lastDay ? ++_j : --_j) {
        if (day === moment(issue.date).date()) {
          $issue.append($("<td>", {
            text: "" + [issue.time],
            "class": "edit-time",
            "data-issueNumber": issue.issueNumber
          }));
        } else {
          $issue.append($("<td>", {
            "class": "edit-time"
          }));
        }
      }
      return $issues.append($issue);
    });
  }
  $issue = $("<tr>", {
    "class": "warning"
  });
  $issue.append("<td></td>");
  $issue.append("<td>&sum;</td>");
  $issue.append("<td>" + sumOverall + "</td>");
  for (day = _j = 1; 1 <= lastDay ? _j <= lastDay : _j >= lastDay; day = 1 <= lastDay ? ++_j : --_j) {
    sum = sumByDay[day] ||  String("");
    $issue.append("<td>" + sum + "</td>");
  }
  $issues.append($issue);
  $("#timetable").append($issues);
  $popup = $("#popup");
  $popup.on("click", function(evt) {
    return $popup.hide();
  });
  $("body").on("click", function(evt) {
    return $popup.hide();
  });
  return $(".edit-time").on("click", function(evt) {
    var $el, issueNumber, value, width;

    evt.stopPropagation();
    $el = $(evt.target);
    width = $el.width();
    value = $el.text();
    issueNumber = $el.data("issueNumber");
    return $popup.toggle();
  });
});
